<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المخزون - SAM Pharmacy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.8.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.4);
        }
        /* Custom Notification styles */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg (8px) */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: fadeInOut 3s forwards; /* Animation duration */
            direction: rtl; /* Ensure RTL layout for notification */
        }
        .custom-notification.success { background-color: #d1fae5; color: #065f46; } /* bg-green-100, text-green-800 */
        .custom-notification.error { background-color: #fee2e2; color: #991b1b; }   /* bg-red-100, text-red-800 */
        .custom-notification.info { background-color: #dbeafe; color: #1e40af; }    /* bg-blue-100, text-blue-800 */
        .custom-notification.warning { background-color: #fffbeb; color: #9a3412; } /* bg-orange-100, text-orange-800 */

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        /* Responsive table for small screens */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #ccc;
                margin-bottom: 0.5rem;
                border-radius: 0.5rem; /* rounded-lg */
                overflow: hidden; /* For rounded borders on tr */
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right; /* Ensure text aligns right for RTL */
            }
            td:before {
                content: attr(data-label);
                position: absolute;
                right: 0.5rem; /* Adjust padding for label */
                width: 45%;
                padding-left: 10px;
                font-weight: bold;
                text-align: left; /* Ensure label aligns left for RTL */
                white-space: nowrap; /* Prevent label wrapping */
                overflow: hidden;
                text-overflow: ellipsis;
            }
            /* Adjust specific column widths for labels */
        }
        /* Style for print area, hidden by default */
        #print-area {
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 9999;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        @media print {
            body > *:not(#print-area) {
                display: none;
            }
            #print-area {
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 pb-24">
    <div class="max-w-7xl mx-auto px-4 pt-6">
        <h1 class="text-2xl font-bold text-blue-900 mb-4 flex items-center gap-2">
            <i class="ri-archive-2-line"></i> إدارة المخزون
        </h1>

        <div id="notifications-container" class="fixed top-4 right-4 z-50 flex flex-col gap-3"></div>

        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex flex-wrap gap-3 mb-4 items-center">
                <button onclick="openAddProductModal()" class="bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-800 transition-colors">
                    <i class="ri-add-circle-line"></i> إضافة منتج جديد
                </button>
                <button onclick="openBarcodeScannerModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700 transition-colors">
                    <i class="ri-barcode-box-line"></i> بحث بالباركود
                </button>
                <button onclick="document.getElementById('importModal').showModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700 transition-colors">
                    <i class="ri-file-excel-line"></i> استيراد Excel/CSV
                </button>
                <button onclick="document.getElementById('printBarcodesModal').showModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-purple-700 transition-colors">
                    <i class="ri-barcode-line"></i> طباعة باركود
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <input type="text" id="productSearch" onkeyup="filterProducts()" placeholder="البحث بالاسم، الكود، أو الباركود..." 
                       class="border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <select id="categoryFilter" onchange="filterProducts()" class="border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">جميع الفئات</option>
                    <option value="مسكنات">مسكنات</option>
                    <option value="مضادات حيوية">مضادات حيوية</option>
                    <option value="فيتامينات">فيتامينات</option>
                    <option value="ضغط وسكري">أدوية الضغط والسكري</option>
                    </select>
                <select id="statusFilter" onchange="filterProducts()" class="border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">جميع الحالات</option>
                    <option value="متوفر">متوفر</option>
                    <option value="مخزون منخفض">مخزون منخفض</option>
                    <option value="قريب الانتهاء">قريب الانتهاء</option>
                    <option value="منتهي الصلاحية">منتهي الصلاحية</option>
                    <option value="نفد المخزون">نفد المخزون</option>
                </select>
                <select id="supplierFilter" onchange="filterProducts()" class="border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">جميع الموردين</option>
                    </select>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-50 text-blue-800">
                    <tr>
                        <th class="px-4 py-2 text-right text-sm">اسم المنتج</th>
                        <th class="px-4 py-2 text-right text-sm">الباركود</th>
                        <th class="px-4 py-2 text-right text-sm">الكمية</th>
                        <th class="px-4 py-2 text-right text-sm">الوحدة</th>
                        <th class="px-4 py-2 text-right text-sm">السعر</th>
                        <th class="px-4 py-2 text-right text-sm">تاريخ الإنتاج</th>
                        <th class="px-4 py-2 text-right text-sm">تاريخ الانتهاء</th>
                        <th class="px-4 py-2 text-right text-sm">المورد</th>
                        <th class="px-4 py-2 text-right text-sm">الحالة</th>
                        <th class="px-4 py-2 text-right text-sm">إجراءات</th>
                    </tr>
                </thead>
                <tbody id="products-table" class="bg-white divide-y divide-gray-100">
                    <tr><td colspan="10" class="text-center py-4 text-gray-500">جاري تحميل المنتجات...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-md flex justify-around py-2 z-10">
        <a href="index.html" class="flex flex-col items-center text-sm text-gray-600 hover:text-blue-700 transition-colors">
            <i class="ri-home-line text-lg"></i> الرئيسية
        </a>
        <a href="#" class="flex flex-col items-center text-sm text-blue-700 font-semibold">
            <i class="ri-archive-2-line text-lg"></i> المخزون
        </a>
        <a href="sales.html" class="flex flex-col items-center text-sm text-gray-600 hover:text-blue-700 transition-colors">
            <i class="ri-shopping-cart-line text-lg"></i> نقطة البيع
        </a>
        <a href="clients.html" class="flex flex-col items-center text-sm text-gray-600 hover:text-blue-700 transition-colors">
            <i class="ri-user-line text-lg"></i> العملاء
        </a>
        <a href="settings.html" class="flex flex-col items-center text-sm text-gray-600 hover:text-blue-700 transition-colors">
            <i class="ri-settings-3-line text-lg"></i> الإعدادات
        </a>
    </nav>

    <dialog id="addProductModal" class="rounded-lg p-0 w-full max-w-xl shadow-lg">
        <form id="productForm" class="p-6 bg-white rounded-lg" method="dialog">
            <h2 id="modalTitle" class="text-lg font-bold text-blue-900 mb-4">إضافة منتج جديد</h2>
            <div class="grid grid-cols-1 gap-4 mb-4">
                <input type="hidden" id="productId" value=""> <input id="tradeName" placeholder="اسم المنتج" class="border p-2 rounded-lg" required />
                <input id="barcode" placeholder="الباركود" class="border p-2 rounded-lg" />
                <input id="quantity" type="number" placeholder="الكمية" class="border p-2 rounded-lg" required min="0" />
                <input id="unit" placeholder="الوحدة (مثال: علبة)" class="border p-2 rounded-lg" />
                <input id="price" type="number" step="0.01" placeholder="السعر" class="border p-2 rounded-lg" required min="0" />
                <label for="productionDate" class="block text-gray-700 text-sm font-semibold pt-2">تاريخ الإنتاج:</label>
                <input id="productionDate" type="date" class="border p-2 rounded-lg" />
                <label for="expiry" class="block text-gray-700 text-sm font-semibold">تاريخ الانتهاء:</label>
                <input id="expiry" type="date" class="border p-2 rounded-lg" />
                <input id="supplier" placeholder="اسم المورد" class="border p-2 rounded-lg" />
                <input id="activeIngredient" placeholder="المادة الفعالة (اختياري)" class="border p-2 rounded-lg" />
                <select id="category" class="border p-2 rounded-lg">
                    <option value="">اختر الفئة (اختياري)</option>
                    <option value="مسكنات">مسكنات</option>
                    <option value="مضادات حيوية">مضادات حيوية</option>
                    <option value="فيتامينات">فيتامينات</option>
                    <option value="ضغط وسكري">أدوية الضغط والسكري</option>
                </select>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="document.getElementById('addProductModal').close()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">إلغاء</button>
                <button type="submit" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">حفظ</button>
            </div>
        </form>
    </dialog>

    <dialog id="barcodeScannerModal" class="rounded-lg p-0 w-full max-w-sm shadow-lg">
        <div class="p-6 bg-white rounded-lg text-center">
            <h2 class="text-lg font-bold text-blue-900 mb-4">بحث بالباركود</h2>
            <div class="text-gray-700 mb-4">
                <i class="ri-barcode-line text-5xl text-blue-500 mb-2"></i>
                <p>أدخل الباركود هنا:</p>
            </div>
            <input type="text" id="barcodeInput" placeholder="أدخل الباركود..." class="border p-2 rounded-lg w-full mb-4" />
            <div class="flex justify-end gap-2">
                <button type="button" onclick="document.getElementById('barcodeScannerModal').close()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">إلغاء</button>
                <button type="button" onclick="searchByBarcode()" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">بحث</button>
            </div>
        </div>
    </dialog>

    <dialog id="importModal" class="rounded-lg p-0 w-full max-w-md shadow-lg">
        <div class="p-6 bg-white rounded-lg">
            <h2 class="text-lg font-bold text-blue-900 mb-4">استيراد المنتجات</h2>
            <p class="text-gray-700 mb-4">اختر ملف Excel (.xlsx) أو CSV (.csv) لاستيراد المنتجات. يجب أن يحتوي الملف على أعمدة مثل: "اسم المنتج", "الباركود", "الكمية", "السعر", "تاريخ الانتاج", "تاريخ الانتهاء", "المورد".</p>
            <input type="file" id="importFileInput" accept=".xlsx, .xls, .csv" class="border p-2 rounded-lg w-full mb-4" />
            <div class="flex justify-end gap-2">
                <button type="button" onclick="document.getElementById('importModal').close()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">إلغاء</button>
                <button type="button" onclick="importProducts()" class="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-800 transition-colors">استيراد</button>
            </div>
        </div>
    </dialog>

    <dialog id="printBarcodesModal" class="rounded-lg p-0 w-full max-w-xl shadow-lg">
        <div class="p-6 bg-white rounded-lg">
            <h2 class="text-lg font-bold text-blue-900 mb-4">طباعة باركود</h2>
            <div class="mb-4">
                <p class="text-gray-700 mb-2">حدد المنتجات التي تريد طباعة الباركود لها:</p>
                <select id="selectProductForBarcode" class="border p-2 rounded-lg w-full mb-2">
                    <option value="">اختر منتج...</option>
                    </select>
                <input type="number" id="barcodeCopies" value="1" min="1" placeholder="عدد النسخ" class="border p-2 rounded-lg w-full" />
            </div>
            <div id="barcodePreview" class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50 max-h-60 overflow-y-auto">
                <p class="text-gray-500 text-center col-span-full">اختر منتجاً لتوليد الباركود.</p>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="document.getElementById('printBarcodesModal').close()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">إلغاء</button>
                <button type="button" onclick="printSelectedBarcodes()" class="px-4 py-2 bg-purple-700 text-white rounded-lg hover:bg-purple-800 transition-colors">طباعة</button>
            </div>
        </div>
    </dialog>

    <div id="print-area"></div>

    <script type="module">
        // Firebase SDKs and config
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        // Firebase configuration (using the one from your last request)
        const firebaseConfig = {
            apiKey: "AIzaSyAdIxUhzpPVStGe_TcYuvcvB92prpVc3Ek",
            authDomain: "pharmacy-app-5e2a5.firebaseapp.com",
            projectId: "pharmacy-app-5e2a5",
            storageBucket: "pharmacy-app-5e2a5.firebasestorage.app",
            messagingSenderId: "133467785388",
            appId: "1:133467785388:web:fea35872581791f974b709",
            measurementId: "G-C1KTS3F4KP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const productsCollection = collection(db, 'products');
        const suppliersCollection = collection(db, 'suppliers'); 

        let allProducts = []; // To store all products for filtering

        /**
         * Displays a custom notification message on the UI.
         * @param {string} message The message to display.
         * @param {'success'|'error'|'info'|'warning'} type The type of notification.
         * @param {number} duration The duration in milliseconds before the notification fades out.
         */
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notifications-container');
            if (!container) {
                console.error('Notifications container not found!');
                return;
            }

            const notificationDiv = document.createElement('div');
            notificationDiv.className = `custom-notification ${type}`;
            notificationDiv.innerHTML = `
                <i class="${getNotificationIcon(type)} text-xl"></i>
                <span class="flex-grow">${message}</span>
                <button class="text-gray-600 hover:text-gray-800 absolute top-2 left-2" onclick="this.closest('.custom-notification').remove()">
                    <i class="ri-close-line"></i>
                </button>
            `;
            container.appendChild(notificationDiv);

            setTimeout(() => {
                notificationDiv.remove();
            }, duration);
        }

        /** Helper to get Remixicon based on notification type */
        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'ri-checkbox-circle-fill';
                case 'error': return 'ri-error-warning-fill';
                case 'warning': return 'ri-alert-fill';
                case 'info': return 'ri-information-fill';
                default: return 'ri-notification-fill';
            }
        }

        /**
         * Loads products from Firestore and populates the table.
         * Also updates the global allProducts array for filtering and barcode printing.
         */
        async function loadProducts() {
            const tableBody = document.getElementById('products-table');
            tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">جاري تحميل المنتجات...</td></tr>`;

            try {
                const snapshot = await getDocs(productsCollection);
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                filterProducts(); // Call filter to display initially
                populateBarcodePrintSelect(); // Populate select for printing
            } catch (error) {
                showNotification('خطأ في تحميل المنتجات: ' + error.message, 'error');
                console.error("Error loading products:", error);
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-red-500">فشل تحميل المنتجات. يرجى المحاولة مرة أخرى.</td></tr>`;
            }
        }

        /**
         * Filters and displays products based on search and filter criteria.
         */
        window.filterProducts = function() { // Make it global for onchange/onkeyup
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const supplierFilter = document.getElementById('supplierFilter').value;
            const tableBody = document.getElementById('products-table');
            tableBody.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time for accurate date comparison
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(today.getDate() + 30);

            const filteredProducts = allProducts.filter(product => {
                const matchesSearch = searchTerm === '' ||
                                      (product.tradeName && product.tradeName.toLowerCase().includes(searchTerm)) ||
                                      (product.barcode && product.barcode.toLowerCase().includes(searchTerm)) ||
                                      (product.activeIngredient && product.activeIngredient.toLowerCase().includes(searchTerm));

                const matchesCategory = categoryFilter === '' ||
                                        (product.category && product.category === categoryFilter);

                const matchesSupplier = supplierFilter === '' ||
                                        (product.supplier && product.supplier === supplierFilter);

                let matchesStatus = true;
                if (statusFilter !== '') {
                    if (statusFilter === 'متوفر') {
                        matchesStatus = product.quantity > 50; // Example threshold: > 50 considered sufficient
                    } else if (statusFilter === 'مخزون منخفض') {
                        matchesStatus = product.quantity <= 50 && product.quantity > 0;
                    } else if (statusFilter === 'قريب الانتهاء') {
                        if (product.expiry) {
                            const expiryDate = new Date(product.expiry);
                            matchesStatus = expiryDate > today && expiryDate <= thirtyDaysFromNow;
                        } else {
                            matchesStatus = false;
                        }
                    } else if (statusFilter === 'منتهي الصلاحية') {
                        if (product.expiry) {
                            const expiryDate = new Date(product.expiry);
                            matchesStatus = expiryDate < today;
                        } else {
                            matchesStatus = false;
                        }
                    } else if (statusFilter === 'نفد المخزون') {
                        matchesStatus = product.quantity === 0;
                    }
                }

                return matchesSearch && matchesCategory && matchesSupplier && matchesStatus;
            });

            if (filteredProducts.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">لا توجد منتجات مطابقة لعملية البحث.</td></tr>`;
                return;
            }

            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                let statusText = 'متوفر';
                let statusClass = 'bg-green-100 text-green-800';

                if (product.quantity === 0) {
                    statusText = 'نفد المخزون';
                    statusClass = 'bg-gray-100 text-gray-800';
                } else if (product.quantity <= 50) { // Example low stock threshold
                    statusText = 'مخزون منخفض';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                }
                
                if (product.expiry) {
                    const expiryDate = new Date(product.expiry);
                    if (expiryDate < today) {
                        statusText = 'منتهي الصلاحية';
                        statusClass = 'bg-red-100 text-red-800';
                    } else if (expiryDate > today && expiryDate <= thirtyDaysFromNow) {
                        statusText = 'قريب الانتهاء';
                        statusClass = 'bg-orange-100 text-orange-800';
                    }
                }
                
                // Format dates for display (handle cases where dates might be null/empty)
                const productionDateDisplay = product.productionDate ? product.productionDate : '--';
                const expiryDateDisplay = product.expiry ? product.expiry : '--';


                row.innerHTML = `
                    <td class="px-4 py-2" data-label="اسم المنتج:">
                        <div class="font-semibold text-gray-900">${product.tradeName || '---'}</div>
                        <div class="text-xs text-gray-500">${product.activeIngredient || ''}</div>
                    </td>
                    <td class="px-4 py-2 text-sm" data-label="الباركود:">${product.barcode || '---'}</td>
                    <td class="px-4 py-2 text-sm" data-label="الكمية:">${product.quantity || 0}</td>
                    <td class="px-4 py-2 text-sm" data-label="الوحدة:">${product.unit || 'علبة'}</td>
                    <td class="px-4 py-2 text-sm" data-label="السعر:">${(product.price || 0).toFixed(2)} ج.م</td>
                    <td class="px-4 py-2 text-sm" data-label="تاريخ الإنتاج:">${productionDateDisplay}</td>
                    <td class="px-4 py-2 text-sm" data-label="تاريخ الانتهاء:">${expiryDateDisplay}</td>
                    <td class="px-4 py-2 text-sm" data-label="المورد:">${product.supplier || '--'}</td>
                    <td class="px-4 py-2" data-label="الحالة:">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-2 space-x-1 rtl:space-x-reverse" data-label="الإجراءات:">
                        <button onclick="editProduct('${product.id}')" class="text-sm text-blue-600 hover:underline">تعديل</button>
                        <button onclick="deleteProduct('${product.id}')" class="text-sm text-red-600 hover:underline">حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * Loads suppliers for the filter dropdown.
         */
        async function loadSuppliersForFilter() {
            const supplierFilterSelect = document.getElementById('supplierFilter');
            // Keep default "جميع الموردين" option
            const defaultOption = supplierFilterSelect.querySelector('option[value=""]');
            supplierFilterSelect.innerHTML = '';
            supplierFilterSelect.appendChild(defaultOption || new Option('جميع الموردين', ''));

            try {
                const snapshot = await getDocs(suppliersCollection);
                snapshot.forEach(doc => {
                    const supplier = doc.data();
                    const option = document.createElement('option');
                    option.value = supplier.name; // Assuming supplier name is unique
                    option.textContent = supplier.name;
                    supplierFilterSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading suppliers for filter:", error);
            }
        }

        /**
         * Opens the add/edit product modal, populating it if editing.
         * @param {string} [productId] The ID of the product to edit, if any.
         */
        window.openAddProductModal = async function (productId = null) {
            const modal = document.getElementById('addProductModal');
            const form = document.getElementById('productForm');
            const modalTitle = document.getElementById('modalTitle');
            const hiddenProductId = document.getElementById('productId');

            form.reset(); // Clear form fields
            hiddenProductId.value = ''; // Clear hidden ID

            if (productId) {
                modalTitle.textContent = 'تعديل منتج';
                try {
                    const productDoc = await getDoc(doc(productsCollection, productId));
                    if (productDoc.exists()) {
                        const product = productDoc.data();
                        hiddenProductId.value = productId;
                        document.getElementById('tradeName').value = product.tradeName || '';
                        document.getElementById('barcode').value = product.barcode || '';
                        document.getElementById('quantity').value = product.quantity || 0;
                        document.getElementById('unit').value = product.unit || '';
                        document.getElementById('price').value = product.price || 0;
                        document.getElementById('productionDate').value = product.productionDate || '';
                        document.getElementById('expiry').value = product.expiry || '';
                        document.getElementById('supplier').value = product.supplier || '';
                        document.getElementById('activeIngredient').value = product.activeIngredient || '';
                        document.getElementById('category').value = product.category || '';
                    } else {
                        showNotification('المنتج المطلوب للتعديل غير موجود.', 'error');
                        modal.close();
                        return;
                    }
                } catch (error) {
                    showNotification('خطأ في جلب بيانات المنتج للتعديل: ' + error.message, 'error');
                    console.error("Error fetching product for edit:", error);
                    modal.close();
                    return;
                }
            } else {
                modalTitle.textContent = 'إضافة منتج جديد';
            }
            modal.showModal();
        };

        /**
         * Handles the submission of the add/edit product form.
         */
        document.getElementById('productForm').addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent default form submission

            const productId = document.getElementById('productId').value;
            const tradeName = document.getElementById('tradeName').value;
            const barcode = document.getElementById('barcode').value;
            const quantity = parseInt(document.getElementById('quantity').value || 0);
            const unit = document.getElementById('unit').value || 'علبة';
            const price = parseFloat(document.getElementById('price').value || 0);
            const productionDate = document.getElementById('productionDate').value;
            const expiry = document.getElementById('expiry').value; // Date string
            const supplier = document.getElementById('supplier').value;
            const activeIngredient = document.getElementById('activeIngredient').value;
            const category = document.getElementById('category').value;

            if (!tradeName || quantity < 0 || price < 0) { // Quantity and price can be 0, but not negative
                showNotification('الرجاء إدخال اسم المنتج، الكمية، والسعر بشكل صحيح (لا يمكن أن تكون القيم سالبة).', 'error');
                return;
            }

            const productData = {
                tradeName,
                barcode: barcode || null,
                quantity,
                unit,
                price,
                productionDate: productionDate || null,
                expiry: expiry || null,
                supplier: supplier || null,
                activeIngredient: activeIngredient || null,
                category: category || null
            };

            try {
                if (productId) {
                    // Update existing product
                    await updateDoc(doc(productsCollection, productId), productData);
                    showNotification('تم تحديث المنتج بنجاح!', 'success');
                } else {
                    // Add new product
                    productData.createdAt = new Date().toISOString(); // Add creation timestamp for new products
                    await addDoc(productsCollection, productData);
                    showNotification('تم إضافة المنتج بنجاح!', 'success');
                }
                document.getElementById('addProductModal').close();
                document.getElementById('productForm').reset(); // Clear form fields
                loadProducts(); // Reload products to update the table
            } catch (error) {
                showNotification('حدث خطأ أثناء حفظ المنتج: ' + error.message, 'error');
                console.error("Error saving product:", error);
            }
        });

        /**
         * Deletes a product from Firestore.
         * @param {string} productId The ID of the product document to delete.
         */
        window.deleteProduct = async function (productId) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.')) {
                try {
                    await deleteDoc(doc(productsCollection, productId));
                    showNotification('تم حذف المنتج بنجاح!', 'success');
                    loadProducts(); // Reload products to update the table
                } catch (error) {
                    showNotification('حدث خطأ أثناء الحذف: ' + error.message, 'error');
                    console.error("Error deleting product:", error);
                }
            }
        };

        // Make editProduct globally accessible
        window.editProduct = window.openAddProductModal;

        /**
         * Opens the barcode scanner modal.
         */
        window.openBarcodeScannerModal = function() {
            document.getElementById('barcodeInput').value = ''; // Clear previous input
            document.getElementById('barcodeScannerModal').showModal();
        };

        /**
         * Searches for a product by barcode and filters the table.
         */
        window.searchByBarcode = function() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            document.getElementById('barcodeScannerModal').close();
            
            if (barcode) {
                document.getElementById('productSearch').value = barcode; // Put barcode in search field
                filterProducts(); // Apply filter
                showNotification(`تم البحث عن المنتج بالباركود: ${barcode}`, 'info');
            } else {
                showNotification('لم يتم إدخال باركود للبحث.', 'warning');
            }
        };

        /**
         * Populates the product selection dropdown in the print barcodes modal.
         */
        function populateBarcodePrintSelect() {
            const selectElement = document.getElementById('selectProductForBarcode');
            selectElement.innerHTML = '<option value="">اختر منتج...</option>'; // Clear and add default
            allProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.tradeName} (${product.barcode || 'لا يوجد باركود'})`;
                selectElement.appendChild(option);
            });
        }

        /**
         * Generates and displays barcodes in the preview area.
         */
        document.getElementById('selectProductForBarcode').addEventListener('change', function() {
            const productId = this.value;
            const barcodePreview = document.getElementById('barcodePreview');
            const barcodeCopiesInput = document.getElementById('barcodeCopies');
            const numCopies = parseInt(barcodeCopiesInput.value) || 1;

            barcodePreview.innerHTML = ''; // Clear previous barcodes

            if (productId) {
                const product = allProducts.find(p => p.id === productId);
                if (product && product.barcode) {
                    for (let i = 0; i < numCopies; i++) {
                        const barcodeContainer = document.createElement('div');
                        barcodeContainer.className = 'flex flex-col items-center p-2 border rounded-lg bg-white';
                        barcodeContainer.style.breakInside = 'avoid-column'; /* For print layout */

                        const productNameDiv = document.createElement('div');
                        productNameDiv.className = 'text-xs font-semibold text-gray-800 mb-1';
                        productNameDiv.textContent = product.tradeName;

                        const barcodeSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        barcodeSvg.setAttribute("jsbarcode-value", product.barcode);
                        barcodeSvg.setAttribute("jsbarcode-textmargin", "0");
                        barcodeSvg.setAttribute("jsbarcode-font-size", "10");
                        barcodeSvg.setAttribute("jsbarcode-height", "40");
                        barcodeSvg.setAttribute("jsbarcode-width", "1");
                        barcodeSvg.setAttribute("jsbarcode-displayvalue", "true"); /* Display barcode text */
                        
                        barcodeContainer.appendChild(productNameDiv);
                        barcodeContainer.appendChild(barcodeSvg);
                        barcodePreview.appendChild(barcodeContainer);

                        // Generate barcode using JsBarcode
                        try {
                             JsBarcode(barcodeSvg).init(); // Initialize the SVG as a barcode
                        } catch (e) {
                             showNotification(`خطأ في توليد الباركود لـ ${product.tradeName}: ${e.message}`, 'error');
                             console.error("JsBarcode error:", e);
                        }
                    }
                } else {
                    barcodePreview.innerHTML = '<p class="text-gray-500 text-center col-span-full">هذا المنتج لا يحتوي على باركود.</p>';
                    showNotification('المنتج المختار لا يحتوي على باركود.', 'warning');
                }
            } else {
                barcodePreview.innerHTML = '<p class="text-gray-500 text-center col-span-full">اختر منتجاً لتوليد الباركود.</p>';
            }
        });

        // Update barcode preview when number of copies changes
        document.getElementById('barcodeCopies').addEventListener('input', function() {
            const selectElement = document.getElementById('selectProductForBarcode');
            if (selectElement.value) {
                selectElement.dispatchEvent(new Event('change')); // Trigger change to regenerate barcodes
            }
        });

        /**
         * Prints the selected barcodes.
         */
        window.printSelectedBarcodes = async function() {
            const barcodePreviewContent = document.getElementById('barcodePreview');
            if (barcodePreviewContent.innerHTML.includes('svg')) { // Check if any barcodes are generated
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = ''; // Clear previous content

                // Append the entire preview content to the print area
                printArea.appendChild(barcodePreviewContent.cloneNode(true)); 
                
                showNotification('جاري تجهيز الطباعة...', 'info');
                // Use html2canvas to render the content for a cleaner print (optional, can directly window.print)
                try {
                    const canvas = await html2canvas(printArea, { scale: 2 }); // Higher scale for better print quality
                    const imgData = canvas.toDataURL('image/png');
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write('<html><head><title>طباعة باركود</title></head><body style="text-align:center;">');
                    newWindow.document.write('<img src="' + imgData + '" style="max-width:100%; height:auto;" onload="window.print();window.close()" />');
                    newWindow.document.write('</body></html>');
                    newWindow.document.close();
                } catch (error) {
                    console.error("Error generating print image:", error);
                    showNotification('خطأ في تحضير الطباعة. يرجى المحاولة مرة أخرى.', 'error');
                    // Fallback to simpler print if html2canvas fails
                    window.print();
                }
            } else {
                showNotification('لا توجد باركودات لتتم طباعتها. الرجاء اختيار منتج وتوليد الباركود أولاً.', 'warning');
            }
        };


        /**
         * Imports products from a selected Excel/CSV file.
         */
        window.importProducts = async function() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('الرجاء اختيار ملف Excel/CSV للاستيراد.', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    if (!json.length) {
                        showNotification('الملف فارغ أو لا يحتوي على بيانات صالحة.', 'error');
                        return;
                    }

                    let importedCount = 0;
                    let errorCount = 0;
                    let batch = []; // For batching Firestore writes (optional, but good for large imports)

                    for (const row of json) {
                        // Map Excel/CSV columns to Firestore fields
                        const productData = {
                            tradeName: row['اسم المنتج'] || null,
                            barcode: row['الباركود'] ? String(row['الباركود']) : null, // Ensure barcode is string
                            quantity: parseInt(row['الكمية']) || 0,
                            unit: row['الوحدة'] || 'علبة',
                            price: parseFloat(row['السعر']) || 0,
                            productionDate: row['تاريخ الانتاج'] ? new Date(row['تاريخ الانتاج']).toISOString().split('T')[0] : null, // Convert Excel date to YYYY-MM-DD
                            expiry: row['تاريخ الانتهاء'] ? new Date(row['تاريخ الانتهاء']).toISOString().split('T')[0] : null, // Convert Excel date to YYYY-MM-DD
                            supplier: row['المورد'] || null,
                            activeIngredient: row['المادة الفعالة'] || null,
                            category: row['الفئة'] || null,
                            createdAt: new Date().toISOString()
                        };

                        // Basic validation for required fields
                        if (!productData.tradeName || productData.quantity < 0 || productData.price < 0) {
                            console.warn('Skipping invalid row:', row);
                            errorCount++;
                            continue;
                        }

                        // Add to batch or directly to Firestore
                        try {
                            await addDoc(productsCollection, productData);
                            importedCount++;
                        } catch (firestoreError) {
                            console.error("Error adding product from import:", firestoreError);
                            errorCount++;
                        }
                    }

                    showNotification(`تم استيراد ${importedCount} منتج بنجاح. (${errorCount} أخطاء).`, importedCount > 0 ? 'success' : 'error');
                    loadProducts(); // Reload table after import
                    document.getElementById('importModal').close();
                    fileInput.value = ''; // Clear file input
                } catch (excelError) {
                    showNotification('خطأ في قراءة ملف الاستيراد. تأكد من أن التنسيق صحيح.', 'error');
                    console.error("Excel import error:", excelError);
                }
            };
            reader.readAsArrayBuffer(file);
        };


        // Initial load of products and suppliers when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadSuppliersForFilter();
        });
    </script>
</body>
</html>
