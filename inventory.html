<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إدارة المخزون - SAM Pharmacy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
    }
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.4);
    }
  </style>
</head>
<body class="bg-gray-100 pb-24">
  <div class="max-w-7xl mx-auto px-4 pt-6">
    <h1 class="text-2xl font-bold text-blue-900 mb-4 flex items-center gap-2">
      <i class="ri-archive-2-line"></i>
      إدارة المخزون
    </h1>

        <div class="flex flex-wrap gap-3 mb-4">
      <button onclick="document.getElementById('addProductModal').showModal()" class="bg-blue-700 text-white px-4 py-2 rounded-xl flex items-center gap-2">
        <i class="ri-add-circle-line"></i>
        إضافة منتج جديد
      </button>
    </div>

        <div class="bg-white rounded-xl shadow overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-blue-50 text-blue-800">
          <tr>
            <th class="px-4 py-2 text-right">اسم المنتج</th>
            <th class="px-4 py-2 text-right">الباركود</th>
            <th class="px-4 py-2 text-right">الكمية</th>
            <th class="px-4 py-2 text-right">الوحدة</th>
            <th class="px-4 py-2 text-right">السعر</th>
            <th class="px-4 py-2 text-right">تاريخ الانتهاء</th>
            <th class="px-4 py-2 text-right">المورد</th>
            <th class="px-4 py-2 text-right">إجراءات</th>
          </tr>
        </thead>
        <tbody id="products-table" class="bg-white divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-md flex justify-around py-2">
    <a href="dashboard.html" class="flex flex-col items-center text-sm text-gray-600"><i class="ri-home-line text-lg"></i>الرئيسية</a>
    <a href="#" class="flex flex-col items-center text-sm text-blue-700 font-semibold"><i class="ri-archive-2-line text-lg"></i>المخزون</a>
    <a href="sales.html" class="flex flex-col items-center text-sm text-gray-600"><i class="ri-shopping-cart-line text-lg"></i>نقطة البيع</a>
    <a href="clients.html" class="flex flex-col items-center text-sm text-gray-600"><i class="ri-user-line text-lg"></i>العملاء</a>
    <a href="settings.html" class="flex flex-col items-center text-sm text-gray-600"><i class="ri-settings-3-line text-lg"></i>الإعدادات</a>
  </nav>

    <dialog id="addProductModal" class="rounded-xl p-0 w-full max-w-xl">
    <form method="dialog" class="p-6 bg-white rounded-xl">
      <h2 class="text-lg font-bold text-blue-900 mb-4">إضافة منتج جديد</h2>
      <div class="grid grid-cols-1 gap-4">
        <input id="tradeName" placeholder="اسم المنتج" class="border p-2 rounded" required />
        <input id="barcode" placeholder="الباركود" class="border p-2 rounded" />
        <input id="quantity" type="number" placeholder="الكمية" class="border p-2 rounded" />
        <input id="unit" placeholder="الوحدة (مثال: علبة)" class="border p-2 rounded" />
        <input id="price" type="number" step="0.01" placeholder="السعر" class="border p-2 rounded" />         <input id="expiry" type="date" class="border p-2 rounded" />
        <input id="supplier" placeholder="اسم المورد" class="border p-2 rounded" />
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" onclick="document.getElementById('addProductModal').close()" class="px-4 py-2 bg-gray-200 rounded">إلغاء</button>
        <button type="button" onclick="addProduct()" class="px-4 py-2 bg-blue-700 text-white rounded">حفظ</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    // Firebase SDKs and config
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

    // Firebase configuration - Using the one provided in your last request
    const firebaseConfig = {
      apiKey: "AIzaSyAdIxUhzpPVStGe_TcYuvcvB92prpVc3Ek",
      authDomain: "pharmacy-app-5e2a5.firebaseapp.com",
      projectId: "pharmacy-app-5e2a5",
      storageBucket: "pharmacy-app-5e2a5.firebasestorage.app",
      messagingSenderId: "133467785388",
      appId: "1:133467785388:web:fea35872581791f974b709",
      measurementId: "G-C1KTS3F4KP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const productsCollection = collection(db, 'products');

    /**
     * Displays a notification message.
     * @param {string} message The message to display.
     * @param {'success'|'error'|'info'} type The type of notification.
     */
    function showNotification(message, type = 'info') {
      // For simplicity, using a basic alert. In a real app, integrate with your existing notification system.
      alert(`${type.toUpperCase()}: ${message}`);
    }

    /**
     * Loads products from Firestore and populates the table.
     */
    async function loadProducts() {
      const tableBody = document.getElementById('products-table');
      tableBody.innerHTML = ''; // Clear existing rows

      try {
        const snapshot = await getDocs(productsCollection);
        if (snapshot.empty) {
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">لا توجد منتجات حاليًا في المخزون.</td></tr>`;
          return;
        }

        snapshot.forEach(docProduct => {
          const product = docProduct.data();
          const productId = docProduct.id; // Get the document ID for actions

          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50'; // Tailwind class for hover effect
          row.innerHTML = `
            <td class="px-4 py-2">${product.tradeName || '---'}</td>
            <td class="px-4 py-2">${product.barcode || '---'}</td>
            <td class="px-4 py-2">${product.quantity || 0}</td>
            <td class="px-4 py-2">${product.unit || 'علبة'}</td>
            <td class="px-4 py-2">${(product.price || 0).toFixed(2)} ج.م</td>
            <td class="px-4 py-2">${product.expiry || '--'}</td>
            <td class="px-4 py-2">${product.supplier || '--'}</td>
            <td class="px-4 py-2 space-x-1 rtl:space-x-reverse">
              <button onclick="deleteProduct('${productId}')" class="text-sm text-red-600 hover:underline">حذف</button>
            </td>
          </tr>
        `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        showNotification('خطأ في تحميل المنتجات: ' + error.message, 'error');
        console.error("Error loading products:", error);
      }
    }

    /**
     * Adds a new product to Firestore.
     */
    window.addProduct = async function () {
      const tradeName = document.getElementById('tradeName').value;
      const barcode = document.getElementById('barcode').value;
      const quantity = parseInt(document.getElementById('quantity').value || 0);
      const unit = document.getElementById('unit').value || 'علبة';
      const price = parseFloat(document.getElementById('price').value || 0);
      const expiry = document.getElementById('expiry').value; // Date string
      const supplier = document.getElementById('supplier').value;

      if (!tradeName || quantity <= 0 || price <= 0) {
        showNotification('الرجاء إدخال اسم المنتج، الكمية، والسعر بشكل صحيح.', 'error');
        return;
      }

      try {
        await addDoc(productsCollection, {
          tradeName,
          barcode: barcode || null, // Allow null if empty
          quantity,
          unit,
          price,
          expiry: expiry || null, // Allow null if empty
          supplier: supplier || null, // Allow null if empty
          createdAt: new Date() // Store as Firestore Timestamp
        });
        document.getElementById('addProductModal').close();
        document.getElementById('addProductModal').querySelector('form').reset(); // Clear form fields
        showNotification('تم إضافة المنتج بنجاح!', 'success');
        loadProducts(); // Reload products to update the table
      } catch (error) {
        showNotification('حدث خطأ أثناء الإضافة: ' + error.message, 'error');
        console.error("Error adding product:", error);
      }
    }

    /**
     * Deletes a product from Firestore.
     * @param {string} productId The ID of the product document to delete.
     */
    window.deleteProduct = async function (productId) {
      if (confirm('هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع عن هذا الإجراء.')) {
        try {
          await deleteDoc(doc(db, 'products', productId));
          showNotification('تم حذف المنتج بنجاح!', 'success');
          loadProducts(); // Reload products to update the table
        } catch (error) {
          showNotification('حدث خطأ أثناء الحذف: ' + error.message, 'error');
          console.error("Error deleting product:", error);
        }
      }
    }

    // Initial load of products when the page loads
    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>
